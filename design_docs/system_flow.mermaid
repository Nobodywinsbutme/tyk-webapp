graph TD
    %% --- ƒê·ªäNH NGHƒ®A STYLE ---
    classDef actor fill:#f9f,stroke:#333,stroke-width:2px,color:black;
    classDef db fill:#ff9,stroke:#e6b800,stroke-width:2px,color:black;
    classDef page fill:#d4edda,stroke:#28a745,stroke-width:1px,color:black;
    classDef process fill:#cce5ff,stroke:#007bff,stroke-width:1px,color:black;
    classDef decision fill:#fff3cd,stroke:#ffc107,stroke-width:1px,color:black;
    classDef adminaction fill:#f8d7da,stroke:#dc3545,stroke-width:2px,color:black;
    classDef restricted fill:#ffcccc,stroke:#dc3545,stroke-width:2px,color:black,stroke-dasharray: 5 5;

    %% --- ACTORS & DB ---
    Guest((Kh√°ch - Ch∆∞a Login)):::actor
    User((Ng∆∞·ªùi d√πng - ƒê√£ Login)):::actor
    Admin((Qu·∫£n tr·ªã vi√™n)):::actor
    DB[(MySQL Database\nAiven Cloud)]:::db

    %% --- 1. KHU V·ª∞C C√îNG C·ªòNG (AI C≈®NG TH·∫§Y) ---
    Guest -->|Truy c·∫≠p Web| HomePage[Trang ch·ªß / Home]:::page
    
    subgraph Public Zone [Khu v·ª±c C√¥ng c·ªông]
        HomePage --> NewsPage[Trang Tin t·ª©c / News]:::page
        HomePage --> GuidePage[Trang H∆∞·ªõng d·∫´n / Guide]:::page
        HomePage --> GameStatusPublic[Game Status - Xem thi·∫øt k·∫ø]:::page
        
        %% CH·ª¢ L√Ä C√îNG C·ªòNG (Xem & T√¨m ki·∫øm)
        HomePage --> MarketplacePage[Ch·ª£ / MarketplaceTYK]:::page
        MarketplacePage -->|Load danh s√°ch| GetListingsAPI[API L·∫•y MarketListings]:::process
        GetListingsAPI -- Read --> DB
        
        MarketplacePage --> SearchFunc[üîç T√¨m ki·∫øm ƒê·ªì & Ng∆∞·ªùi]:::process
        SearchFunc -- Query --> DB
    end

    %% --- 2. H·ªÜ TH·ªêNG X√ÅC TH·ª∞C (GATEKEEPER) ---
    subgraph Auth System [H·ªá th·ªëng X√°c th·ª±c]
        HomePage -->|Click Login/Signup| AuthModals[Modal ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω]:::process
        AuthModals -->|Submit Form| AuthAPI{API Ki·ªÉm tra}:::decision
        AuthAPI -->|Th·∫•t b·∫°i| ShowError[Hi·ªán l·ªói UI]:::process
        AuthAPI -->|Th√†nh c√¥ng| LoginSuccess[L∆∞u Session/Token]:::process
        LoginSuccess -->|Chuy·ªÉn vai tr√≤| User
    end
    AuthAPI -- CRUD User/Check Ban --> DB

    %% --- 3. H√ÄNH ƒê·ªòNG H·∫†N CH·∫æ (C·∫¶N LOGIN) ---
    %% Logic: T·ª´ Ch·ª£ b·∫•m n√∫t -> Check Login -> N·∫øu OK m·ªõi cho l√†m ti·∫øp
    subgraph Restricted Actions [H√†nh ƒë·ªông c·∫ßn ƒêƒÉng nh·∫≠p]
        direction TB
        %% C√°c n√∫t b·∫•m tr√™n Ch·ª£
        MarketplacePage --> BtnBuy[N√∫t Mua / Bid]:::restricted
        MarketplacePage --> BtnChat[N√∫t Nh·∫Øn tin]:::restricted
        MarketplacePage --> BtnReport[N√∫t T·ªë c√°o]:::restricted

        %% C·ªïng ki·ªÉm so√°t
        BtnBuy & BtnChat & BtnReport --> CheckLogin{ƒê√£ Login?}:::decision
        
        %% Ch∆∞a Login -> ƒê√° v·ªÅ Modal
        CheckLogin -- No --> AuthModals
        
        %% ƒê√£ Login -> Th·ª±c hi·ªán API
        CheckLogin -- Yes --> ExecuteAction[Th·ª±c hi·ªán h√†nh ƒë·ªông]:::process
    end

    %% --- 4. KHU V·ª∞C NG∆Ø·ªúI D√ôNG (USER ZONE) ---
    User -->|Xem l·∫°i| HomePage
    User -->|Truy c·∫≠p| InventoryPage[Kho ƒë·ªì c√° nh√¢n]:::page
    User -->|Truy c·∫≠p| UserProfilePage[H·ªì s∆° c√° nh√¢n]:::page
    User -->|Click Logout| LogoutAPI[API ƒêƒÉng xu·∫•t]:::process --> Guest

    subgraph User Features [Ch·ª©c nƒÉng Ng∆∞·ªùi d√πng]
        %% B√°n h√†ng (T·ª´ kho)
        InventoryPage -->|Load ƒë·ªì| GetInventoryAPI[API L·∫•y Inventory]:::process
        GetInventoryAPI -- Read --> DB
        InventoryPage -->|Ch·ªçn ƒë·ªì -> B√°n| SellAPI[API ƒêƒÉng b√°n]:::process
        SellAPI -- Create Listing --> DB

        %% Mua h√†ng (T·ª´ c·ªïng ExecuteAction xu·ªëng)
        ExecuteAction -->|X·ª≠ l√Ω Mua| BuyTransaction[Giao d·ªãch: Tr·ª´ ti·ªÅn + Chuy·ªÉn ƒë·ªì]:::process
        BuyTransaction -- Update DB --> DB

        %% Chat & Report (T·ª´ c·ªïng ExecuteAction xu·ªëng)
        ExecuteAction -->|X·ª≠ l√Ω Chat| SaveChat[L∆∞u ChatMessage]:::process
        SaveChat --> DB
        ExecuteAction -->|X·ª≠ l√Ω Report| SaveReport[L∆∞u UserReport]:::process
        SaveReport --> DB

        %% Game Status Upload
        UserProfilePage -->|Upload Map/Skin| UploadDesignAPI[API ƒêƒÉng thi·∫øt k·∫ø]:::process
        UploadDesignAPI -- Save Design (PENDING) --> DB
        
        %% Xem l·ªãch s·ª≠ chat
        UserProfilePage -->|Xem tin nh·∫Øn| GetChatHistory[API L·∫•y l·ªãch s·ª≠ Chat]:::process
        GetChatHistory -- Read --> DB
    end

    %% --- 5. KHU V·ª∞C ADMIN ---
    subgraph Admin Dashboard [Trang qu·∫£n tr·ªã Admin]
        Admin -->|Login Admin| AdminPage[Giao di·ªán Admin]:::adminaction

        %% Qu·∫£n l√Ω Item
        AdminPage -->|T·∫°o v·∫≠t ph·∫©m m·∫´u| CreateItemAPI[API T·∫°o ItemDefinition]:::adminaction
        CreateItemAPI -- Insert --> DB

        %% Duy·ªát thi·∫øt k·∫ø
        AdminPage -->|Xem b√†i ch·ªù duy·ªát| ReviewDesignAPI{Duy·ªát thi·∫øt k·∫ø?}:::decision
        ReviewDesignAPI -->|Approve/Reject| UpdateDesignDB[Update Status]:::adminaction
        UpdateDesignDB -- Update --> DB

        %% X·ª≠ l√Ω Ban
        AdminPage -->|Xem t·ªë c√°o| ReviewReportAPI{X·ª≠ l√Ω Report?}:::decision
        ReviewReportAPI -->|Ban User| BanUserAPI[API Ban User]:::adminaction
        BanUserAPI -- Update isBanned --> DB
    end

    %% --- LI√äN K·∫æT D·ªÆ LI·ªÜU ---
    GameStatusPublic -.->|Ch·ªâ hi·ªán b√†i APPROVED| DB