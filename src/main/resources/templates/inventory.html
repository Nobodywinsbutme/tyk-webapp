<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Inventory | TYK</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" th:href="@{/img/logo.png}">

    <style>
        /* === GLOBAL THEME === */
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 80px; /* Tránh bị Navbar che mất nội dung */
        }

        /* === CUSTOM NAVBAR (Copy từ Marketplace) === */
        .marketplace-nav {
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 0;
        }
        .nav-link-custom {
            color: #ccc;
            font-weight: 600;
            margin-right: 15px;
            text-decoration: none;
            transition: 0.3s;
        }
        .nav-link-custom:hover, .nav-link-custom.active {
            color: #84cc16;
        }
        
        /* Search Bar Navbar */
        .search-container-nav {
            position: relative;
            max-width: 500px;
            width: 100%;
        }
        .search-input-nav {
            background-color: #2b2b2b;
            border: 1px solid #444;
            color: white;
            border-radius: 20px;
            padding: 8px 15px 8px 40px;
            width: 100%;
        }
        .search-input-nav:focus { outline: none; border-color: #84cc16; background-color: #333; }
        .search-icon-nav { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }

        /* Inventory Button Navbar */
        .btn-inventory-nav {
            background-color: #84cc16;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            text-decoration: none;
        }
        .btn-inventory-nav:hover { background-color: #65a30d; color: white; }

        /* === SIDEBAR FILTERS === */
        .filter-btn {
            background-color: #374151; /* Gray-700 */
            color: #d1d5db;
            border: none;
            border-radius: 50px;
            padding: 6px 16px;
            font-size: 0.9rem;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .filter-btn:hover { background-color: #4b5563; color: white; }
        .filter-btn.active {
            background-color: #84cc16; /* Lime */
            color: black;
            font-weight: bold;
        }

        .sidebar-search input {
            background-color: #2b2b2b;
            border: 1px solid #4b5563;
            color: white;
            border-radius: 10px;
            padding: 10px 10px 10px 40px;
        }
        .sidebar-search input:focus {
            background-color: #2b2b2b;
            border-color: #84cc16;
            box-shadow: none;
            color: white;
        }
        .sidebar-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        /* === MAIN CONTENT AREA === */
        .inventory-card {
            background-color: #222;
            border-radius: 24px; /* Rounded 3xl */
            min-height: 700px;
            padding: 24px;
        }

        /* Tabs */
        .custom-tabs {
            border-bottom: 1px solid #374151;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
        }
        .tab-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 10px 10px 0 0;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: white; }
        .tab-btn.active {
            background-color: #84cc16;
            color: black;
        }

        /* Item Grid Card */
        .item-card {
            background-color: #2b2b2b;
            border: 1px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .item-card:hover {
            transform: translateY(-5px);
            border-color: #6b7280;
        }
        .item-image-box {
            height: 180px;
            background-color: #1f2937; /* Gray-800 */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
        }
        .item-image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .not-tradeable-badge {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            color: #d1d5db;
            font-size: 10px;
            text-align: center;
            padding: 2px 0;
        }
        .rarity-text { font-size: 0.8rem; text-transform: uppercase; }
        
        /* Pagination Buttons */
        .pagination-btn {
            width: 35px; height: 35px;
            border-radius: 50%;
            border: none;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            margin: 0 4px;
        }
        .pagination-btn.active { background-color: #84cc16; color: black; }
        .pagination-btn.inactive { background-color: #374151; color: white; }
        .pagination-btn.inactive:hover { background-color: #4b5563; }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg marketplace-nav fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center me-4" th:href="@{/}">
                <img th:src="@{/img/logo.png}" alt="Logo" style="height: 35px;" class="me-2">
                <span class="fw-bold text-white">Marketplace<span class="text-warning">TYK</span></span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon bg-secondary rounded"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="d-flex align-items-center me-auto">
                    <a href="/marketplace" class="nav-link-custom"><i class="bi bi-shop me-1"></i> Market</a>
                    <a href="/bid" class="nav-link-custom"><i class="bi bi-hammer me-1"></i> Bid</a>
                </div>

                <div class="d-none d-md-block search-container-nav mx-auto">
                    <i class="bi bi-search search-icon-nav"></i>
                    <input type="text" class="search-input-nav" placeholder="Search items, collections...">
                </div>

                <div class="d-flex align-items-center gap-3 ms-auto">
                    <div id="coinBadge" class="d-none d-lg-flex align-items-center bg-dark border border-secondary rounded-pill px-3 py-1">
                        <i class="bi bi-coin text-warning me-2"></i>
                        <span id="displayCoin" class="fw-bold">0</span>
                    </div>

                    <div id="authButtons">
                        <button class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#registerModal">Sign Up</button>
                    </div>
                    <div id="userProfile" class="d-none"></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-lg-5 py-4">
        <div class="row">
            
            <div class="col-lg-3 col-md-4 mb-4">
                <input type="hidden" id="userId" th:value="${user.id}">

                <h5 class="fw-bold mb-3"><i class="bi bi-funnel"></i> Filters</h5>
                <div id="typeFilters" class="d-flex flex-wrap gap-2 mb-4">
                    <button onclick="filterType('weapon')" class="filter-btn" id="btn-weapon">Weapon</button>
                    <button onclick="filterType('armor')" class="filter-btn" id="btn-armor">Armor</button>
                    <button onclick="filterType('skin')" class="filter-btn" id="btn-skin">Skin</button>
                </div>

                <div class="position-relative sidebar-search mb-4">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name...">
                </div>

                <div class="mb-3">
                    <label class="text-secondary text-sm mb-2">Rarity</label>
                    <select class="form-select bg-dark text-white border-secondary">
                        <option>All Rarities</option>
                        <option>Common</option>
                        <option>Rare</option>
                        <option>Legendary</option>
                    </select>
                </div>
            </div>

            <div class="col-lg-9 col-md-8">
                <div class="inventory-card">
                    
                    <div class="custom-tabs">
                        <button class="tab-btn active">Owned</button>
                        <button class="tab-btn">On sale</button>
                        <button class="tab-btn">Bookmark</button>
                        <button class="tab-btn">Offer</button>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="text-secondary"><span id="totalItems" class="text-white fw-bold">0</span> Items found</span>
                        <div>
                            <button class="btn btn-dark border-secondary p-2"><i class="bi bi-grid-fill text-warning"></i></button>
                            <button class="btn btn-dark border-secondary p-2"><i class="bi bi-list"></i></button>
                        </div>
                    </div>

                    <div id="inventoryGrid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4">
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-warning" role="status"></div>
                            <p class="text-secondary mt-2">Loading your treasure...</p>
                        </div>
                    </div>

                    <div class="mt-5 d-flex justify-content-center" id="pagination">
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/modals :: registerModal}"></div>
    <div th:replace="~{fragments/modals :: loginModal}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/auth.js}"></script>
    
    <script>
        const userId = document.getElementById('userId').value;
        let currentType = ''; 
        let currentPage = 1;

        // 1. Hàm gọi API
        async function loadInventory(page = 1) {
            currentPage = page;
            const search = document.getElementById('searchInput').value;
            
            let url = `/api/inventory/${userId}?page=${page}&size=12`;
            if (currentType) url += `&type=${currentType}`;
            if (search) url += `&search=${search}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                
                renderItems(data.content); 
                renderPagination(data.totalPages, page);
                document.getElementById('totalItems').textContent = data.totalElements;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('inventoryGrid').innerHTML = '<p class="text-center text-danger col-12">Failed to load inventory.</p>';
            }
        }

        // 2. Hàm vẽ HTML cho từng Item
        function renderItems(items) {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = ''; 

            if (!items || items.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-box2 display-1 text-secondary"></i>
                        <p class="mt-3 text-secondary">No items found in your inventory.</p>
                    </div>`;
                return;
            }

            items.forEach(item => {
                // Logic Badge: Kiểm tra trường 'tradable' từ JSON trả về
                // (DTO: isTradable -> JSON: tradable)
                let badge = item.tradable ? '' : '<div class="not-tradeable-badge">Cannot be traded</div>';
                let rarityColor = item.rarity === 'RARE' ? 'text-warning' : (item.rarity === 'LEGENDARY' ? 'text-danger fw-bold' : 'text-secondary');

                const cardHtml = `
                    <div class="col">
                        <div class="item-card h-100">
                            <div class="item-image-box">
                                <img src="${item.imageUrl || '/img/logo.png'}" alt="${item.name}">
                                ${badge}
                            </div>
                            <div class="p-3">
                                <h6 class="text-white fw-bold text-truncate mb-1" title="${item.name}">${item.name}</h6>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="text-secondary" style="font-size: 0.8rem">Qty: ${item.quantity}</span>
                                    <span class="${rarityColor} rarity-text">${item.rarity}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHtml;
            });
        }

        // 3. Hàm vẽ phân trang
        function renderPagination(totalPages, current) {
            const pag = document.getElementById('pagination');
            pag.innerHTML = '';
            if(totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.innerText = i;
                btn.className = `pagination-btn ${i === current ? 'active' : 'inactive'}`;
                btn.onclick = () => loadInventory(i);
                pag.appendChild(btn);
            }
        }

        // 4. Sự kiện Filter Type
        function filterType(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            if (currentType === type) {
                currentType = ''; // Bỏ chọn
            } else {
                currentType = type;
                document.getElementById(`btn-${type}`).classList.add('active');
            }
            loadInventory(1);
        }

        // 5. Sự kiện Search
        let timeout = null;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => loadInventory(1), 500);
        });

        // Load lần đầu
        document.addEventListener("DOMContentLoaded", () => {
            loadInventory();
        });
    </script>
</body>
</html>