<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Inventory | TYK</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" th:href="@{/img/logo.png}">

    <style>
        /* === GLOBAL THEME === */
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 80px; /* Tránh bị Navbar che mất nội dung */
        }

        /* === CUSTOM NAVBAR (Copy từ Marketplace) === */
        .marketplace-nav {
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 0;
        }
        .nav-link-custom {
            color: #ccc;
            font-weight: 600;
            margin-right: 15px;
            text-decoration: none;
            transition: 0.3s;
        }
        .nav-link-custom:hover, .nav-link-custom.active {
            color: #84cc16;
        }
        
        /* Search Bar Navbar */
        .search-container-nav {
            position: relative;
            max-width: 500px;
            width: 100%;
        }
        .search-input-nav {
            background-color: #2b2b2b;
            border: 1px solid #444;
            color: white;
            border-radius: 20px;
            padding: 8px 15px 8px 40px;
            width: 100%;
        }
        .search-input-nav:focus { outline: none; border-color: #84cc16; background-color: #333; }
        .search-icon-nav { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }

        /* Inventory Button Navbar */
        .btn-inventory-nav {
            background-color: #84cc16;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            text-decoration: none;
        }
        .btn-inventory-nav:hover { background-color: #65a30d; color: white; }

        /* === SIDEBAR FILTERS === */
        .filter-btn {
            background-color: #374151; /* Gray-700 */
            color: #d1d5db;
            border: none;
            border-radius: 50px;
            padding: 6px 16px;
            font-size: 0.9rem;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .filter-btn:hover { background-color: #4b5563; color: white; }
        .filter-btn.active {
            background-color: #84cc16; /* Lime */
            color: black;
            font-weight: bold;
        }

        .sidebar-search input {
            background-color: #2b2b2b;
            border: 1px solid #4b5563;
            color: white;
            border-radius: 10px;
            padding: 10px 10px 10px 40px;
        }
        .sidebar-search input:focus {
            background-color: #2b2b2b;
            border-color: #84cc16;
            box-shadow: none;
            color: white;
        }
        .sidebar-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        /* === MAIN CONTENT AREA === */
        .inventory-card {
            background-color: #222;
            border-radius: 24px; /* Rounded 3xl */
            min-height: 700px;
            padding: 24px;
        }

        /* Tabs */
        .custom-tabs {
            border-bottom: 1px solid #374151;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
        }
        .tab-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 10px 10px 0 0;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: white; }
        .tab-btn.active {
            background-color: #84cc16;
            color: black;
        }

        /* Item Grid Card */
        .item-card {
            background-color: #2b2b2b;
            border: 1px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .item-card:hover {
            transform: translateY(-5px);
            border-color: #6b7280;
        }
        .item-image-box {
            height: 180px;
            background-color: #1f2937; /* Gray-800 */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
        }
        .item-image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .not-tradeable-badge {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            color: #d1d5db;
            font-size: 10px;
            text-align: center;
            padding: 2px 0;
        }
        .rarity-text { font-size: 0.8rem; text-transform: uppercase; }
        
        /* Pagination Buttons */
        .pagination-btn {
            width: 35px; height: 35px;
            border-radius: 50%;
            border: none;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            margin: 0 4px;
        }
        .pagination-btn.active { background-color: #84cc16; color: black; }
        .pagination-btn.inactive { background-color: #374151; color: white; }
        .pagination-btn.inactive:hover { background-color: #4b5563; }
        .sell-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease; z-index: 10;
        }
        /* Khi di chuột vào card thì hiện lớp phủ */
        .item-card:hover .sell-overlay { opacity: 1; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg marketplace-nav fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center me-4" th:href="@{/}">
                <img th:src="@{/img/logo.png}" alt="Logo" style="height: 35px;" class="me-2">
                <span class="fw-bold text-white">Marketplace<span class="text-warning">TYK</span></span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon bg-secondary rounded"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="d-flex align-items-center me-auto">
                    <a href="/marketplace" class="nav-link-custom"><i class="bi bi-shop me-1"></i> Market</a>
                    <a href="/bid" class="nav-link-custom"><i class="bi bi-hammer me-1"></i> Bid</a>
                </div>

                <div class="d-none d-md-block search-container-nav mx-auto">
                    <i class="bi bi-search search-icon-nav"></i>
                    <input type="text" class="search-input-nav" placeholder="Search items, collections...">
                </div>

                <div class="d-flex align-items-center gap-3 ms-auto">
                    <div id="coinBadge" class="d-none d-lg-flex align-items-center bg-dark border border-secondary rounded-pill px-3 py-1">
                        <i class="bi bi-coin text-warning me-2"></i>
                        <span id="displayCoin" class="fw-bold">0</span>
                    </div>

                    <div id="authButtons">
                        <button class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#registerModal">Sign Up</button>
                    </div>
                    <div id="userProfile" class="d-none"></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-lg-5 py-4">
        <div class="row">
            
            <div class="col-lg-3 col-md-4 mb-4">
                <input type="hidden" id="userId" th:value="${user.id}">

                <h5 class="fw-bold mb-3"><i class="bi bi-funnel"></i> Filters</h5>
                <div id="typeFilters" class="d-flex flex-wrap gap-2 mb-4">
                    <button onclick="filterType('WEAPON')" class="filter-btn" id="btn-WEAPON">Weapon</button>
                    <button onclick="filterType('ARMOR')" class="filter-btn" id="btn-ARMOR">Armor</button>
                    <button onclick="filterType('SKIN')" class="filter-btn" id="btn-SKIN">Skin</button>
                </div>

                <div class="position-relative sidebar-search mb-4">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name...">
                </div>

                <div class="mb-3">
                    <label class="text-secondary text-sm mb-2">Rarity</label>
                    <select class="form-select ..." id="rarityFilter" onchange="filterRarity(this.value)">
                        <option value="">All Rarities</option>
                        <option value="COMMON">Common</option> 
                        <option value="RARE">Rare</option>
                        <option value="LEGENDARY">Legendary</option>
                    </select>
                </div>
            </div>

            <div class="col-lg-9 col-md-8">
                <div class="inventory-card">
                    
                    <div class="custom-tabs">
                        <button class="tab-btn active" onclick="switchTab('owned')" id="tab-owned">Owned</button>
                        <button class="tab-btn" onclick="switchTab('on_sale')" id="tab-on_sale">On sale</button>
                        <button class="tab-btn" onclick="switchTab('bookmark')" id="tab-bookmark">Bookmark</button>
                        <button class="tab-btn" onclick="switchTab('offer')" id="tab-offer">Offer</button>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="text-secondary"><span id="totalItems" class="text-white fw-bold">0</span> Items found</span>
                    </div>

                    <div id="inventoryGrid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4">
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-warning" role="status"></div>
                            <p class="text-secondary mt-2">Loading your treasure...</p>
                        </div>
                    </div>

                    <div class="mt-5 d-flex justify-content-center" id="pagination">
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sellModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Sell Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="sellItemId" />
    
                    <div class="text-center mb-4">
                        <img id="sellItemImg" src="" alt="Item" style="height: 80px; object-fit: contain; margin-bottom: 10px;">
                        <h5 id="sellItemName" class="fw-bold text-warning">Item Name</h5>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-secondary small">Quantity (Max: <span id="sellMaxQty">1</span>)</label>
                        <input type="number" id="sellQuantity" class="form-control bg-secondary text-white border-0" value="1" min="1">
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-secondary small">Price per unit (Coins)</label>
                        <input type="number" id="sellPrice" class="form-control bg-secondary text-white border-0" placeholder="e.g. 1000">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmSell()">Confirm Listing</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Edit Price</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editListingId" />
                    <p class="text-secondary small">Enter new price for this listing:</p>
                    <input type="number" id="editPriceInput" class="form-control bg-secondary text-white border-0" placeholder="New Price">
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmEditPrice()">Update Price</button>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/modals :: registerModal}"></div>
    <div th:replace="~{fragments/modals :: loginModal}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/auth.js}"></script>
    
    <script>

        let currentRarity = ''; // Biến mới

        function filterRarity(rarity) {
            currentRarity = rarity;
            loadInventory(1);
        }

        const userId = document.getElementById('userId').value;
        let currentType = ''; 
        let currentPage = 1;

        // 1. Hàm gọi API
        async function loadInventory(page = 1) {
            currentPage = page;
            const search = document.getElementById('searchInput').value;
            
            let url = `/api/inventory/${userId}?page=${page}&size=12&tab=${currentTab}`;
            if (currentType) url += `&type=${currentType}`;
            if (currentRarity) url += `&rarity=${currentRarity}`;
            if (search) url += `&search=${search}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                
                renderItems(data.content); 
                renderPagination(data.totalPages, page);
                document.getElementById('totalItems').textContent = data.totalElements;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('inventoryGrid').innerHTML = '<p class="text-center text-danger col-12">Failed to load inventory.</p>';
            }
        }

        // 2. Hàm vẽ HTML cho từng Item
        function renderItems(items) {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = ''; 

            if (!items || items.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-box2 display-1 text-secondary"></i>
                        <p class="mt-3 text-secondary">No items found in your inventory.</p>
                    </div>`;
                return;
            }

            items.forEach(item => {
                let actionButton = '';
                let badge = item.tradable ? '' : '<div class="not-tradeable-badge">Cannot be traded</div>';
                let rarityColor = item.rarity === 'RARE' ? 'text-warning' : (item.rarity === 'LEGENDARY' ? 'text-danger fw-bold' : 'text-secondary');

                if (currentTab === 'owned') {
                    // Nếu đang ở kho -> Hiện nút Bán
                    actionButton = `
                                    <button class="btn btn-warning fw-bold shadow" onclick="openSellModal(${item.id}, '${item.name}', '${item.imageUrl || '/img/logo.png'}', ${item.quantity})">
                                        <i class="bi bi-tag-fill me-1"></i> Sell Item
                                    </button>`;
                } else if (currentTab === 'on_sale') {
                    // Nếu đang ở tab On Sale -> Hiện Giá bán
                    actionButton = `
                                    <div class="d-flex flex-column align-items-center w-75">
                                    <div class="bg-black bg-opacity-75 text-warning fw-bold py-1 px-3 rounded mb-2 border border-warning w-100 text-center">
                                        <i class="bi bi-coin"></i> ${(item.price || 0).toLocaleString()}
                                    </div>
                                    
                                    <div class="d-flex gap-2 w-100">
                                        <button class="btn btn-primary btn-sm flex-grow-1 shadow" 
                                                onclick="event.stopPropagation(); openEditModal(${item.id}, ${item.price || 0})" 
                                                title="Edit Price">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm flex-grow-1 shadow" 
                                                onclick="event.stopPropagation(); cancelListing(${item.id})" 
                                                title="Remove from Market">
                                            <i class="bi bi-trash3-fill"></i>
                                        </button>
                                    </div>
                                </div>`;
                }

                const cardHtml = `
                    <div class="col">
                        <div class="item-card h-100 position-relative">
                            <div class="sell-overlay">
                                ${actionButton}
                            </div>
                            <div class="item-image-box">
                                <img src="${item.imageUrl || '/img/logo.png'}" alt="${item.name}">
                                ${badge}
                            </div>
                            <div class="p-3">
                                <h6 class="text-white fw-bold text-truncate mb-1" title="${item.name}">${item.name}</h6>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="text-secondary" style="font-size: 0.8rem">Qty: ${item.quantity}</span>
                                    <span class="${rarityColor} rarity-text">${item.rarity}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHtml;
            });
        }

        // 3. Hàm vẽ phân trang
        function renderPagination(totalPages, current) {
            const pag = document.getElementById('pagination');
            pag.innerHTML = '';
            if(totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.innerText = i;
                btn.className = `pagination-btn ${i === current ? 'active' : 'inactive'}`;
                btn.onclick = () => loadInventory(i);
                pag.appendChild(btn);
            }
        }

        // 4. Sự kiện Filter Type
        function filterType(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            if (currentType === type) {
                currentType = ''; // Bỏ chọn
            } else {
                currentType = type;
                const btn = document.getElementById(`btn-${type}`);
                if(btn) btn.classList.add('active');
            }
            loadInventory(1);
        }

        // 5. Sự kiện Search
        let timeout = null;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => loadInventory(1), 500);
        });

        // Load lần đầu
        document.addEventListener("DOMContentLoaded", () => {
            loadInventory();
        });

        let sellModalInstance;

        function openSellModal(id, name, imageUrl, maxQty) {
            document.getElementById('sellItemId').value = id;
    
            // Hiển thị thông tin (Ảnh, Tên)
            document.getElementById('sellItemName').innerText = name;
            document.getElementById('sellItemImg').src = imageUrl;
            
            // Cập nhật số lượng
            document.getElementById('sellMaxQty').innerText = maxQty;
            const qtyInput = document.getElementById('sellQuantity');
            qtyInput.value = 1;
            qtyInput.max = maxQty; // Không cho nhập quá số lượng đang có
            
            // Reset giá
            document.getElementById('sellPrice').value = '';

            // Mở modal
            sellModalInstance = new bootstrap.Modal(document.getElementById('sellModal'));
            sellModalInstance.show();
        }

        async function confirmSell() {
            const itemId = document.getElementById('sellItemId').value;
            const price = Number(document.getElementById('sellPrice').value);
            const quantity = Number(document.getElementById('sellQuantity').value); // Lấy số lượng
            const userId = document.getElementById('userId').value;

            // Validate
            if(!price || price <= 0) {
                alert("Price must be a positive number greater than 0.");
                return;
            }
            if(!quantity || quantity <= 0) {
                alert("Please enter a valid quantity");
                return;
            }

            try {
                const res = await fetch(`/api/inventory/sell/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Gửi thêm quantity trong body JSON
                    body: JSON.stringify({ 
                        itemId: itemId, 
                        price: price,
                        quantity: quantity 
                    })
                });

                if(res.ok) {
                    alert("Item listed on market successfully!");
                    sellModalInstance.hide();
                    loadInventory(currentPage); 
                } else {
                    const msg = await res.text();
                    alert("Error: " + msg);
                }
            } catch(e) {
                console.error(e);
                alert("Connection error");
            }
        }
        let currentTab = 'owned'; // Mặc định là owned

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Cập nhật giao diện nút Active
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Reset trang về 1 khi chuyển tab
            loadInventory(1);
        }
        async function cancelListing(listingId) {
            if(!confirm("Stop selling this item?")) return;
            try {
                const res = await fetch(`/api/market/${listingId}`, { method: 'DELETE' });
                if(res.ok) {
                    alert("Item returned to inventory.");
                    loadInventory(currentPage); // Load lại danh sách
                } else {
                    alert("Failed to cancel.");
                }
            } catch(e) { console.error(e); }
        }
        let editModalInstance;
        function openEditModal(listingId, currentPrice) {
            document.getElementById('editListingId').value = listingId;
            document.getElementById('editPriceInput').value = currentPrice;
            
            // Khởi tạo và hiện Modal
            editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
            editModalInstance.show();
        }
        async function confirmEditPrice() {
            const listingId = document.getElementById('editListingId').value;
            const newPrice = document.getElementById('editPriceInput').value;

            if(!newPrice || newPrice <= 0) { alert("Invalid price"); return; }

            try {
                // Gọi API update giá
                const res = await fetch(`/api/market/${listingId}?price=${newPrice}`, { method: 'PUT' });
                if(res.ok) {
                    alert("Price updated!");
                    editModalInstance.hide();
                    loadInventory(currentPage);
                } else {
                    alert("Failed to update.");
                }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>