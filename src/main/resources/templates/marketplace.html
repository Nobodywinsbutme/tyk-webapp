<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Marketplace Home | TYK</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" th:href="@{/img/logo.png}">

    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 80px;
        }
        
        /* --- NAVBAR --- */
        .marketplace-nav { background-color: #1a1a1a; border-bottom: 1px solid #333; padding: 10px 0; }
        .nav-link-custom { color: #ccc; font-weight: 600; margin-right: 20px; text-decoration: none; transition: 0.3s; display: flex; align-items: center; }
        .nav-link-custom:hover { color: #84cc16; }
        .nav-link-custom i { margin-right: 6px; font-size: 1.1rem; }
        
        .btn-inventory-nav { background-color: #84cc16; color: black; font-weight: bold; border: none; border-radius: 8px; padding: 6px 16px; text-decoration: none; display: flex; align-items: center; }
        .btn-inventory-nav:hover { background-color: #65a30d; color: white; }

        /* --- HERO SECTION --- */
        .hero-section {
            background: linear-gradient(180deg, #1f1f1f 0%, #121212 100%);
            border-radius: 24px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
            min-height: 350px;
            display: flex;
            align-items: center;
        }

        .hero-bg-art {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://via.placeholder.com/1200x400/222/555?text=Marketplace+Banner'); 
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: 1;
        }

        .hero-content { position: relative; z-index: 10; width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .hero-left { flex: 1; min-width: 300px; }
        .hero-title { font-size: 2.5rem; font-weight: 900; text-transform: uppercase; margin-bottom: 20px; text-shadow: 0 0 10px rgba(132, 204, 22, 0.4); }
        .hero-title span { color: #84cc16; }

        .big-search-box { display: flex; background-color: #2b2b2b; border-radius: 12px; padding: 5px; border: 1px solid #444; max-width: 600px; }
        .search-select { background-color: #383838; color: white; border: none; border-radius: 8px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        .search-input-hero { flex: 1; background: transparent; border: none; color: white; padding: 12px 15px; font-size: 1.1rem; }
        .search-input-hero:focus { outline: none; }
        .search-btn-hero { background-color: #ffc107; border: none; border-radius: 8px; width: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: black; }

        .hero-card { background: rgba(0, 0, 0, 0.85); border: 1px solid #444; border-radius: 20px; padding: 25px; width: 320px; text-align: center; backdrop-filter: blur(8px); }
        .hero-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #84cc16; margin-bottom: 15px; object-fit: cover; background-color: #333; }

        /* --- GRID & DEALS --- */
        .shortcut-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 30px; }
        .shortcut-btn { background-color: #1f1f1f; border: 1px solid #333; border-radius: 15px; padding: 25px; text-align: center; text-decoration: none; color: white; transition: 0.3s; }
        .shortcut-btn:hover { background-color: #2b2b2b; color: #84cc16; border-color: #84cc16; transform: translateY(-3px); }
        .shortcut-icon { font-size: 2.2rem; margin-bottom: 10px; display: block; }

        .section-header { background-color: #1a1a1a; padding: 15px 25px; border-radius: 12px; margin: 40px 0 25px 0; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #84cc16; }
        .deal-card { background-color: #1f1f1f; border-radius: 16px; padding: 20px; text-align: center; transition: 0.3s; border: 1px solid #333; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .deal-card:hover { transform: translateY(-5px); border-color: #84cc16; background-color: #252525; }
        .deal-img { height: 130px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); }
        .deal-price { font-size: 1.25rem; font-weight: bold; color: #ffd700; display: flex; align-items: center; justify-content: center; gap: 5px; }
        
        /* Empty State */
        .empty-deals { padding: 40px; text-align: center; border: 1px dashed #444; border-radius: 16px; color: #666; width: 100%; }
        .empty-deals i { font-size: 3rem; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg marketplace-nav fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center me-5" th:href="@{/}">
                <img th:src="@{/img/logo.png}" alt="Logo" style="height: 38px;" class="me-2">
                <span class="fw-bold text-white fs-4">Marketplace<span class="text-warning">TYK</span></span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon bg-secondary rounded"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav me-auto">
                    <a href="/marketplace/market" class="nav-link-custom">
                        <i class="bi bi-shop-window"></i> Market
                    </a>
                    <a href="/bid" class="nav-link-custom">
                        <i class="bi bi-hammer"></i> Bid
                    </a>
                </div>
                
                <div class="d-flex align-items-center gap-3">
                    <div id="coinBadge" class="d-none d-lg-flex align-items-center bg-dark border border-secondary rounded-pill px-3 py-1">
                        <i class="bi bi-coin text-warning me-2"></i>
                        <span id="displayCoin" class="fw-bold text-white">0</span>
                    </div>

                    <a id="btnInventoryNav" href="/inventory" class="btn-inventory-nav d-none">
                        <i class="bi bi-box-seam-fill me-2"></i> Inventory
                    </a>

                    <div id="authButtons">
                        <button class="btn btn-outline-light btn-sm px-3 me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                        <button class="btn btn-warning btn-sm px-3 fw-bold" data-bs-toggle="modal" data-bs-target="#registerModal">Sign Up</button>
                    </div>
                    
                    <div id="userProfile" class="d-none"></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="hero-section mb-5">
            <div class="hero-bg-art"></div> 
            <div class="hero-content">
                <div class="hero-left">
                    <h1 class="hero-title">Discover Exclusive <br><span>Game Items</span></h1>
                    
                    <form action="/marketplace/market" method="get">
                        <div class="big-search-box shadow-lg">
                            <select class="search-select d-none d-sm-block" name="type">
                                <option value="">All Items</option>
                                <option value="weapon">Weapon</option>
                                <option value="armor">Armor</option>
                                <option value="skin">Skin</option>
                            </select>
                            <input type="text" name="keyword" class="search-input-hero" placeholder="Search items, skills, skins...">
                            <button type="submit" class="search-btn-hero"><i class="bi bi-search"></i></button>
                        </div>
                    </form>
                </div>

                <div class="hero-card shadow">
                    <div id="guestWelcome">
                        <img th:src="@{/img/logo.png}" class="hero-avatar border-secondary p-2">
                        <h5 class="fw-bold">Marketplace TYK</h5>
                        <p class="text-secondary small">Login to start trading and manage your inventory.</p>
                        <button class="btn btn-success w-100 fw-bold mt-2" onclick="switchToLogin()">Login Now</button>
                    </div>
                    
                    <div id="userWelcome" class="d-none text-start">
                        <div class="d-flex align-items-center mb-3">
                            <img src="/img/logo.png" class="hero-avatar m-0 me-3" id="heroUserAvatar" style="width: 60px; height: 60px;">
                            <div>
                                <h6 class="mb-0 text-secondary small">Welcome back,</h6>
                                <h5 class="fw-bold text-warning mb-0" id="heroUsername">User</h5>
                            </div>
                        </div>
                        <div class="bg-dark rounded p-3 mb-3 border border-secondary">
                            <div class="d-flex justify-content-between small text-secondary mb-1">
                                <span>Balance</span>
                                <i class="bi bi-info-circle"></i>
                            </div>
                            <h4 class="fw-bold mb-0 text-white"><i class="bi bi-coin text-warning me-1"></i> <span id="heroBalance">0</span></h4>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="/inventory" class="btn btn-primary btn-sm fw-bold"><i class="bi bi-box-seam me-2"></i> My Inventory</a>
                            <a href="/marketplace/market" class="btn btn-warning btn-sm fw-bold text-dark">Go Shopping</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="shortcut-grid mb-5">
            <a href="/marketplace/market?type=WEAPON" class="shortcut-btn shadow-sm">
                <i class="bi bi-shield-shaded shortcut-icon text-info"></i>
                <h6 class="fw-bold mb-0">Weapon</h6>
            </a>
            
            <a href="/marketplace/market?type=ARMOR" class="shortcut-btn shadow-sm">
                <i class="bi bi-shield-fill shortcut-icon text-warning"></i>
                <h6 class="fw-bold mb-0">Armor</h6>
            </a>
            
            <a href="/marketplace/market?type=SKIN" class="shortcut-btn shadow-sm">
                <i class="bi bi-magic shortcut-icon text-danger"></i>
                <h6 class="fw-bold mb-0">Skin</h6>
            </a>
            
            <a href="/bid" class="shortcut-btn shadow-sm">
                <i class="bi bi-hammer shortcut-icon text-success"></i>
                <h6 class="fw-bold mb-0">Bid</h6>
            </a>
        </div>

        <div class="section-header">
            <div class="d-flex align-items-center">
                <h4 class="fw-bold mb-0 text-white">
                    <i class="bi bi-stars text-warning me-2"></i> Newest Arrivals
                </h4>
                <span class="badge bg-danger ms-3">HOT</span>
            </div>
            <a href="/marketplace/market" class="text-decoration-none text-secondary small">View All <i class="bi bi-arrow-right ms-1"></i></a>
        </div>

        <div th:if="${newItems == null or #lists.isEmpty(newItems)}" class="d-flex justify-content-center mb-5">
            <div class="empty-deals">
                <i class="bi bi-box2"></i>
                <h5>No items listed yet</h5>
                <p class="small mb-0">Be the first to sell something!</p>
            </div>
        </div>

        <div th:unless="${newItems == null or #lists.isEmpty(newItems)}" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-4 mb-5">
            <div class="col" th:each="item : ${newItems}">
                <a th:href="@{/marketplace/market(highlight=${item.id})}" class="text-decoration-none">
                    <div class="deal-card shadow-sm h-100 position-relative">
                        
                        <span class="position-absolute top-0 start-0 badge bg-danger m-2 shadow-sm" style="z-index: 5;">NEW</span>

                        <div class="position-relative text-center">
                            <img th:src="${item.itemDefinition.imageUrl}" class="deal-img" alt="Item Image">
                            
                            <span class="position-absolute bottom-0 end-0 badge bg-dark border border-secondary rounded-pill mb-2 me-2" 
                                  th:if="${item.quantity > 1}"
                                  th:text="'x' + ${item.quantity}">
                                x10
                            </span>
                        </div>

                        <div class="mt-2">
                            <h6 class="text-white text-truncate mb-1" th:text="${item.itemDefinition.name}">Item Name</h6>
                            
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <span class="badge bg-secondary" style="font-size: 0.65rem;" th:text="${item.itemDefinition.type}">TYPE</span>
                                <span class="badge" 
                                      th:classappend="${item.itemDefinition.rarity.toString() == 'LEGENDARY' ? 'bg-warning text-dark' : (item.itemDefinition.rarity.toString() == 'RARE' ? 'bg-info text-dark' : 'bg-secondary')}"
                                      style="font-size: 0.65rem;" 
                                      th:text="${item.itemDefinition.rarity}">RARITY</span>
                            </div>

                            <div class="deal-price">
                                <i class="bi bi-coin text-warning"></i> 
                                <span th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}">0</span>
                            </div>
                        </div>

                        <div class="text-secondary small mt-3 pt-2 border-top border-secondary d-flex justify-content-between">
                            <span><i class="bi bi-person-circle me-1"></i> <span th:text="${item.seller.username}">User</span></span>
                            <span th:text="${#temporals.format(item.listedAt, 'HH:mm dd/MM')}">Time</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>

    </div>

    <div th:replace="~{fragments/modals :: registerModal}"></div>
    <div th:replace="~{fragments/modals :: loginModal}"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/auth.js}"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Khởi tạo trạng thái User
        initMarketplaceUI();

        // 2. Xử lý Form tìm kiếm ở Hero Section
        const searchForm = document.querySelector('form[action="/marketplace/market"]');
        if(searchForm){
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const type = this.querySelector('select[name="type"]').value;
                const keyword = this.querySelector('input[name="keyword"]').value;
                
                // Chuyển hướng sang trang browse với query params
                let url = `/marketplace/market?keyword=${encodeURIComponent(keyword)}`;
                if(type) url += `&type=${type.toUpperCase()}`;
                window.location.href = url;
            });
        }
    });

    function initMarketplaceUI() {
        const savedUser = localStorage.getItem("tyk_user") || sessionStorage.getItem("tyk_user");
        if (savedUser) {
            const user = JSON.parse(savedUser);
            const guestSection = document.getElementById('guestWelcome');
            const userSection = document.getElementById('userWelcome');
            const inventoryNav = document.getElementById('btnInventoryNav');
            const coinBadge = document.getElementById('coinBadge');

            if(guestSection) guestSection.classList.add('d-none');
            if(userSection) {
                userSection.classList.remove('d-none');
                document.getElementById('heroUsername').innerText = user.username;
                document.getElementById('heroBalance').innerText = (user.coinBalance || 0).toLocaleString();
                
                // Đồng bộ với Navbar
                if(inventoryNav) inventoryNav.classList.remove('d-none');
                if(coinBadge) {
                    coinBadge.classList.remove('d-none');
                    document.getElementById('displayCoin').innerText = (user.coinBalance || 0).toLocaleString();
                }
            }
        }
    }
    </script>
</body>
</html>